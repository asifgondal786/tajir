import { useState, useEffect, useCallback } from "react";
/**
 * Get the current position and dimensions of a mounted component in terminal cells.
 *
 * @param ref - React ref pointing to a Box component
 * @returns Position object with col, row, width, and height
 */
const usePosition = (ref) => {
    const [position, setPosition] = useState(undefined);
    const updatePosition = useCallback(() => {
        if (!ref.current?.yogaNode) {
            return;
        }
        const { current: node } = ref;
        const { yogaNode } = node;
        // Calculate absolute position by traversing up the tree
        let absoluteCol = 0;
        let absoluteRow = 0;
        let appWidth = 0;
        let appHeight = 0;
        let currentNode = node;
        while (currentNode) {
            if (currentNode.yogaNode) {
                absoluteCol += currentNode.yogaNode.getComputedLeft();
                absoluteRow += currentNode.yogaNode.getComputedTop();
                appWidth = currentNode.yogaNode.getComputedWidth();
                appHeight = currentNode.yogaNode.getComputedHeight();
            }
            currentNode = currentNode.parentNode;
        }
        const newPosition = {
            col: absoluteCol,
            row: absoluteRow,
            width: yogaNode.getComputedWidth(),
            height: yogaNode.getComputedHeight(),
            appWidth,
            appHeight,
        };
        setPosition((previousPosition) => {
            // Only update if position actually changed to avoid unnecessary re-renders
            if (!previousPosition ||
                previousPosition.col !== newPosition.col ||
                previousPosition.row !== newPosition.row ||
                previousPosition.width !== newPosition.width ||
                previousPosition.height !== newPosition.height ||
                previousPosition.appWidth !== newPosition.appWidth ||
                previousPosition.appHeight !== newPosition.appHeight) {
                return newPosition;
            }
            return previousPosition;
        });
    }, [ref]);
    // Calculate position after every render
    // This ensures we capture all layout changes from the root node down
    // Otherwise we will need to track changes in all of the node's parent nodes which is also expensive
    useEffect(() => {
        updatePosition();
    });
    return position;
};
export default usePosition;
